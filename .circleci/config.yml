######################################
# Reusable steps should be added here.
######################################
install-dependencies: &install-dependencies
  run:
    name: Install Dependencies
    command: |
      # pip installing virtualenv in Python 3 will be a no-op
      pip install virtualenv
      virtualenv .venv
      . .venv/bin/activate

      make install-deps

install-dependencies-without-extras: &install-dependencies-without-extras
  run:
    name: Install Dependencies without extras
    command: |
      # pip installing virtualenv in Python 3 will be a no-op
      pip install virtualenv
      virtualenv .venv
      . .venv/bin/activate

      make install-deps-without-extras

lint: &lint
  run:
    name: Run Linters
    command: |
      . .venv/bin/activate

      make lint

test: &test
  run:
    name: Run Tests
    command: |
      . .venv/bin/activate

      make test

authenticate-aws: &authenticate-aws
  run:
    name: Authenticate with a particular ECR instance on AWS
    command: |
      aws configure set default.region "${AWS_DEFAULT_REGION:-us-east-1}"
      printf "${AWS_CREDENTIALS}" > ~/.aws/credentials

publish: &publish
  run:
    name: Publish Python distribution to Artifactory
    command: |
      sudo pip3 install twine
      lucha aws whitelist --profile artifactory -- make publish

publish-docs: &publish-docs
  run:
    name: Publish docs to latest.
    command: |
      virtualenv .venv
      . .venv/bin/activate

      sudo pip install sphinx m2r
      make cicd-publish-docs

###################
# Job Definitions
###################
jobs:

  build:
    docker:
      - image: schireson/cicd-python
      - image: postgres:9.6.10-alpine
        environment:
          POSTGRES_DB: dev
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
      - image: circleci/mongo:3.6.12
    steps:
      - checkout
      - restore_cache:
          key: dep3-{{ checksum "deps/dev-requirements.txt" }}-{{ checksum "deps/requirements.txt" }}2
      - <<: *install-dependencies
      - save_cache:
          paths:
            - .venv
          key: dep3-{{ checksum "deps/dev-requirements.txt" }}-{{ checksum "deps/requirements.txt" }}2
      - <<: *lint
      - setup_remote_docker
      - <<: *test

  build-without-extras:
    docker:
      - image: schireson/cicd-python
    steps:
      - checkout
      - restore_cache:
          key: no-extras-dep-{{ checksum "deps/dev-requirements.txt" }}-{{ checksum "deps/requirements.txt" }}2
      - <<: *install-dependencies-without-extras
      - save_cache:
          paths:
            - .venv
          key: no-extras-dep-{{ checksum "deps/dev-requirements.txt" }}-{{ checksum "deps/requirements.txt" }}2
      - setup_remote_docker
      - run:
          name: Run Tests
          command: |
            . .venv/bin/activate
            make test-without-extras

  build-py2:
    docker:
      - image: circleci/python:2.7.14
      - image: postgres:9.6.10-alpine
        environment:
          POSTGRES_DB: dev
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
      - image: circleci/mongo:3.6.12
        command: "mongod --journal"
    steps:
      - checkout
      - restore_cache:
          key: dep2-{{ checksum "deps/dev-requirements-py2.txt" }}-{{ checksum "deps/requirements-py2.txt" }}2
      - <<: *install-dependencies
      - save_cache:
          paths:
            - .venv
          key: dep2-{{ checksum "deps/dev-requirements-py2.txt" }}-{{ checksum "deps/requirements-py2.txt" }}s
      - setup_remote_docker
      - <<: *test

  publish:
    docker:
      - image: schireson/cicd-python
    steps:
      - checkout
      - <<: *authenticate-aws
      - <<: *publish
      - <<: *publish-docs

###########
# Workflows
###########
version: 2
workflows:
  version: 2

  build_all:
    jobs:
      - build
      - build-py2
      - build-without-extras

      - publish:
          requires:
            - build
            - build-py2
            - build-without-extras
          filters:
            branches:
              only:
                - /^master$/
